# Copyright 2026 Bob Bomar
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

wopr-baseapp:
  app:
    name: wopr-api
  replicaCount: 1

  image:
    registry: ghcr.io
    repository: travismontana/wopr/wopr-api
    tag: latest
    pullPolicy: Always

  service:
    type: ClusterIP
    port: 8000

  ingress:
    enabled: true
    className: wopr-traefik
    hosts:
      - host: api.wopr.tailandtraillabs.org
        paths:
          - path: /
            pathType: Prefix
    tls: 
      - secretName: wopr-api-tls
        hosts:
          - api.wopr.tailandtraillabs.org
  
  env:
    - name: WOPR_ENVIRONMENT
      valueFrom:
        configMapKeyRef:
          name: wopr-config
          key: WOPR_ENVIRONMENT
    - name: DBUSER
      valueFrom:
        secretKeyRef:
          name: wopr-db-user-credentials
          key: username
    - name: DBPASSWORD
      valueFrom:
        secretKeyRef:
          name: wopr-db-user-credentials
          key: password
    - name: DBHOST
      valueFrom:
        secretKeyRef:
          name: wopr-db-cluster-app
          key: host
    - name: DBPORT
      valueFrom:
        secretKeyRef:
          name: wopr-db-cluster-app
          key: port
    - name: DBNAME
      value: "wopr-db-database"
    - name: CONFDBNAME
      value: "wopr-config-db-database"
    - name: CONFDBUSER
      valueFrom:
        secretKeyRef:
          name: wopr-config-db-user-credentials
          key: username
    - name: CONFDBPASSWORD
      valueFrom:
        secretKeyRef:
          name: wopr-config-db-user-credentials
          key: password
    - name: HOMEASSISTANT_TOKEN
      valueFrom:
        secretKeyRef:
          name: wopr-homeassistant-token
          key: HOMEASSISTANT_TOKEN
    - name: LABEL_STUDIO_TOKEN
      valueFrom:
        secretKeyRef:
          name: labelstudio-token-secret
          key: labelstudio-token

      
  woprConfig:
    WOPR_VERSION: "v0.1.5-alpha"
    WOPR_ENVIRONMENT: "production"
    WOPR_METADATA_DB: "wopr-db-database"
    WOPR_API_URL: "http://wopr-api.wopr.svc:8000"

  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000
  volumeMounts:
    - name: wopr-data
      mountPath: /remote/wopr
      readOnly: true
  volumes:
    - name: wopr-data
      persistentVolumeClaim:
        claimName: wopr-api-nfs-pvc

  args:
    - "/home/wopr/.local/bin/uvicorn"
    - "app.main:app"
    - "--host"
    - "0.0.0.0"
    - "--port"
    - "8000"

  celeryWorker1:
    enabled: true
    replicaCount: 1
    env:
      - name: CELERY_BROKER_URL
        value: "redis://wopr-api-valkey:6379/0"
      - name: CELERY_RESULT_BACKEND
        value: "redis://wopr-api-valkey:6379/0"

valkey:
  enabled: true
  master:
    persistence:
      enabled: true
      size: 1Gi