kube-prometheus-stack:
  chunksCache:
    enabled: false
  crds:
    upgradeJob:
      enabled: true
  alertmanager:
    enabled: true
    ingress:
      enabled: true
      ingressClassName: monitoring-traefik
      annotations:
        kubernetes.io/ingress.class: monitoring-traefik
      hosts:
        - alertmanager.wopr.tailandtraillabs.org
      tls:
        - secretName: alertmanager-tls
          hosts:
            - alertmanager.wopr.tailandtraillabs.org
    alertmanagerSpec:
      externalUrl: https://alertmanager.wopr.tailandtraillabs.org
    config:
      global:
        resolve_timeout: 5m
        smtp_smarthost: 'smtp.gmail.com:587'
        smtp_from: 'bob@bomar.us'
        smtp_auth_username: 'bob@bomar.us'
        smtp_auth_password: '{{ secret "alertmanager-smtp" "password" }}'
        smtp_require_tls: true
      route:
        group_by: ['alertname', 'cluster', 'service']
        group_wait: 30s
        group_interval: 5m
        repeat_interval: 12h
        receiver: 'email-bob'
        routes:
          - match:
              severity: critical
            receiver: 'email-bob'
            repeat_interval: 1h
      receivers:
        - name: 'email-bob'
          email_configs:
            - to: 'bob@bomar.us'
              send_resolved: true
              headers:
                Subject: '[{{ .Status | toUpper }}] {{ .GroupLabels.alertname }} - {{ .GroupLabels.cluster }}'
  grafana:
    enabled: true
    ingress:
      enabled: true
      ingressClassName: monitoring-traefik
      annotations:
        kubernetes.io/ingress.class: monitoring-traefik
      hosts:
        - grafana.wopr.tailandtraillabs.org
      tls:
        - secretName: grafana-tls
          hosts:
            - grafana.wopr.tailandtraillabs.org
    adminUser: admin
    adminPassword: admin
    additionalDataSources:
      - name: Loki
        type: loki
        url: http://monitoring-kube-prometheus-stack-loki-gateway:80
        access: proxy
        isDefault: false
    
    # Use envValueFrom for secret injection
    envValueFrom:
      GF_AUTH_GENERIC_OAUTH_CLIENT_ID:
        secretKeyRef:
          name: grafana-oauth
          key: client_id
      GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET:
        secretKeyRef:
          name: grafana-oauth
          key: client_secret
    
    grafana.ini:
      server:
        root_url: https://grafana.wopr.tailandtraillabs.org
      auth.generic_oauth:
        enabled: true
        name: Google
        allow_sign_up: true
        auto_login: false
        scopes: openid email profile
        auth_url: https://accounts.google.com/o/oauth2/v2/auth
        token_url: https://oauth2.googleapis.com/token
        api_url: https://openidconnect.googleapis.com/v1/userinfo
        role_attribute_path: "email == 'bob@bomar.us' && 'Admin' || contains(email, '@bomar.us') && 'Editor' || 'Viewer'"
      auth:
        disable_login_form: false
        oauth_auto_login: false
      users:
        auto_assign_org: true
        auto_assign_org_role: Editor

  prometheus:
    enabled: true
    ingress:
      enabled: true
      ingressClassName: monitoring-traefik
      annotations:
        kubernetes.io/ingress.class: monitoring-traefik
      hosts:
        - prometheus.wopr.tailandtraillabs.org
      paths:
        - /
      pathType: Prefix
      tls:
        - secretName: prometheus-tls
          hosts:
            - prometheus.wopr.tailandtraillabs.org
    prometheusSpec:
      enableRemoteWriteReceiver: true
      enableFeatures:
        - out-of-order-ingestion
      tsdb:
        outOfOrderTimeWindow: 10m
      externalUrl: https://prometheus.wopr.tailandtraillabs.org
      remoteWrite: []
      storageSpec:
        volumeClaimTemplate:
          spec:
            #storageClassName: local-path
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 50Gi

loki:
  test:
    enabled: false
  chunksCache:
    enabled: false
  pattern_ingester:
    enabled: true
  deploymentMode: SingleBinary
  lokiCanary:
    enabled: false
  loki:
    monitoring:
      lokiCanary:
        enabled: false
    auth_enabled: false
    limits_config:
      allow_structured_metadata: true
      volume_enabled: true
    commonConfig:
      replication_factor: 1
    storage:
      type: filesystem
    schemaConfig:
      configs:
        - from: "2024-04-01"
          store: tsdb
          object_store: filesystem
          schema: v13
          index:
            prefix: loki_index_
            period: 24h
    pattern_ingester:
      enabled: true
    limits_config:
      allow_structured_metadata: true
      volume_enabled: true
      retention_period: 744h
    compactor:
      retention_enabled: true
      delete_request_store: filesystem
    ruler:
      enable_api: true
      storage:
        type: local
        local:
          directory: /var/loki/rules
      rule_path: /tmp/loki/scratch

  singleBinary:
    replicas: 1
    persistence:
      enabled: true
      #storageClass:
      size: 50Gi
    extraVolumes:
      - name: rules
        emptyDir: {}
    extraVolumeMounts:
      - name: rules
        mountPath: /var/loki/rules

  gateway:
    enabled: true
    replicas: 1
    ingress:
      enabled: true
      ingressClassName: monitoring-traefik
      hosts:
        - host: loki.wopr.tailandtraillabs.org
          paths:
            - path: /
              pathType: Prefix
      tls:
        - secretName: loki-tls
          hosts:
            - loki.wopr.tailandtraillabs.org

  backend:
    replicas: 0
  read:
    replicas: 0
  write:
    replicas: 0

  monitoring:
    selfMonitoring:
      enabled: false
      grafanaAgent:
        installOperator: false
    lokiCanary:
      enabled: false

  test:
    enabled: false


tempo:  
  tempo:
    metricsGenerator:
      enabled: true
      remoteWriteUrl: "http://prometheus-operated.kube-prometheus-stack:9090/api/v1/write"
      tempo:
        metricsGenerator:
          enabled: true
          processor:
            service_graphs:
              enabled: true
            span_metrics:
              enabled: true
    overrides:
      defaults:
        metrics_generator:
          processors:
            - service-graphs
            - span-metrics
            - local-blocks
    
    tempoQuery:
      enabled: true
      ingress:
        enabled: true
        ingressClassName: monitoring-traefik
        hosts:
          - tempo.wopr.tailandtraillabs.org
        tls:
          - secretName: tempo-tls
            hosts:
              - tempo.wopr.tailandtraillabs.org
    
    persistence:
      enabled: true
      #storageClassName: local-path
      size: 10Gi